# Makefile for Automating Linkerd Setup and Teardown

# Namespace
NAMESPACE=default

# Run Linkerd Installation, Injection, and Dashboard Setup
.PHONY: run
run:
	@echo "ðŸ”„ Installing Linkerd CRDs..."
	linkerd install --crds | kubectl apply -f -

	@echo "ðŸ”„ Installing Linkerd Control Plane..."
	linkerd install | kubectl apply -f -

	@echo "âœ… Checking Linkerd Health..."
	linkerd check

	@echo "ðŸš€ Enabling Linkerd Proxy Injection..."
	kubectl annotate namespace $(NAMESPACE) linkerd.io/inject=enabled --overwrite

	@echo "ðŸ”„ Restarting Deployments for Proxy Injection..."
	kubectl rollout restart deployment -n $(NAMESPACE)

	@echo "ðŸš€ Installing Linkerd Viz Dashboard..."
	linkerd viz install | kubectl apply -f -

	@echo "âœ… Linkerd Viz is ready. Run 'linkerd viz dashboard' to access."

# Teardown Linkerd from Cluster Completely
.PHONY: stop
stop:
	@echo "ðŸ›‘ Uninstalling Linkerd Viz Dashboard..."
	linkerd viz uninstall | kubectl delete -f - || true

	@echo "ðŸ›‘ Uninstalling Linkerd Control Plane..."
	linkerd uninstall | kubectl delete -f - || true

	@echo "ðŸ›‘ Removing Linkerd CRDs..."
	linkerd install --crds | kubectl delete -f - || true

	@echo "ðŸ”„ Removing Linkerd Namespace if Exists..."
	kubectl delete namespace linkerd --ignore-not-found
	kubectl delete namespace linkerd-viz --ignore-not-found

	@echo "ðŸ”„ Restarting Deployments to Remove Sidecars..."
	kubectl rollout restart deployment -n $(NAMESPACE)

	@echo "âœ… Linkerd and its components have been removed from the cluster."

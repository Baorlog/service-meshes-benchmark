SHELL := /bin/bash
NAMESPACE := traefik-mesh
HELM_RELEASE := traefik-mesh
HELM_CHART := traefik/traefik-mesh
SERVICE_FILE := traefik-mesh-proxy-service.yaml

.PHONY: run stop check-traefik wait-for-pods

run: 
	@echo "üöÄ Installing Traefik Mesh in namespace $(NAMESPACE)..."
	@helm repo add traefik https://helm.traefik.io/traefik
	@helm repo update
	@helm install $(HELM_RELEASE) $(HELM_CHART) -n $(NAMESPACE) --create-namespace || { echo "‚ùå Helm install failed"; exit 1; }
	@$(MAKE) wait-for-pods
	@echo "‚úÖ Traefik Mesh installed successfully!"

	@echo "üìå Applying $(SERVICE_FILE)..."
	@kubectl apply -f $(SERVICE_FILE) -n $(NAMESPACE) || { echo "‚ùå Failed to apply service file"; exit 1; }
	@echo "‚úÖ $(SERVICE_FILE) applied successfully!"

stop:
	@echo "üõë Uninstalling Traefik Mesh..."
	@helm uninstall $(HELM_RELEASE) -n $(NAMESPACE) || echo "‚ö†Ô∏è Helm release not found, skipping."
	@kubectl delete namespace $(NAMESPACE) --ignore-not-found
	@echo "‚úÖ Traefik Mesh removed successfully!"

check-traefik:
	@kubectl get pods -n $(NAMESPACE) || echo "‚ö†Ô∏è No pods found in $(NAMESPACE)."

wait-for-pods:
	@echo "‚è≥ Waiting for Traefik Mesh pods (`app=maesh`) to be ready..."
	@kubectl wait --for=condition=Ready pod -l app=maesh -n $(NAMESPACE) --timeout=180s || \
	{ echo "‚ùå Pods failed to become ready"; exit 1; }
	@echo "‚úÖ All Traefik Mesh pods are ready!"
